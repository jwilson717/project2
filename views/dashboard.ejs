<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Dashboard</title>
   <link rel="stylesheet" type='text/css' href="/css/bootstrap.css">
   <link rel="stylesheet" type='text/css' href="/css/styles.css">
   <link rel="stylesheet" type='text/css' href="/css/dashboardStyles.css">
</head>
<body>
   <div id='header' class='shadow-sm p-3 overflow-auto'>
      <h1>Movie Catalog</h1>
      <p class='ml-3'>Welcome <%= user%></p>
      <button type='button' class="btn btn-primary float-right" data-toggle='modal' data-target='#newMovie'>Add Movie</button>
   </div>
   <main class='container'>
      <form id='searchform'>
         <div class='row'>
            <div class='form-group input-group m-2'>
               <input type="text" name="username" id="username" class='hide' value=<%= user %>>
               <input type="text" name="search" id="search" class='form-control' placeholder="Search">
               <button type='button' class='btn btn-light' id='searchbtn'><img src="search_icon.png" alt="search icon" width="20" height="20"></button>
            </div>
         </div>
      </form>
      <div id='results'></div>
      <div class='modal fade' id='newMovie' role='dialog'>
         <div class='modal-dialog modal-dialog-centered'>
            <div class='modal-content'>
               <div class='modal-header'>
                  <h3 class='modal-title' id='newMovieTitle'>Add Movie</h3>
                  <button type="button" class="close" data-dismiss="modal">
                     <span aria-hidden="true">&times;</span>
                   </button>
               </div>
               <div class='modal-body'>
                  <form id='newMovieForm'>
                     <div id='error'></div>
                     <div id='savedResult' class='text-center font-weight-bold'></div>
                     <div class='form-group input-group'>
                        <input type="text" name="title" id="title" class='form-control' placeholder="Title" required>
                     </div>
                     <div class='form-group input-group'>
                        <input type="text" name="year" id="year" class='form-control' placeholder="Release Year" required>
                     </div>
                     <div class='form-group input-group'>
                        <input type="text" name="description" id="description" class='form-control' placeholder="Description" required>
                     </div>  
                     <p>Genres:</p>
                     <% genres.forEach((item) => {%>
                        <div class='form-check form-check-inline'>
                           <input type="checkbox" name="genres[]" id="<%= item.genre%>" value='<%= item.genre%>' class='form-check-input'>
                           <label for="<%= item.genre%>" class='form-check-label'><%= item.genre%></label>
                        </div>
                     <% });%>
                     <label for='rating'>Rating:</label>
                     <select name="rating" id="rating" class='form-control'>
                        <option value="select">--Select--</option>
                        <option value="G">G</option>
                        <option value="PG">PG</option>
                        <option value="PG-13">PG-13</option>
                        <option value="R">R</option>
                        <option value="NR">NR</option>
                     </select>
                  </form>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id='save'>Add</button>
               </div>
            </div>
         </div>
      </div>
   </main>
   <script src='jquery-3.5.1.min.js'></script>
   <script src='bootstrap.js'></script>
   <script>
      $(document).ready(function () {
         $('#searchbtn').click(function () {
            search();
         });

         $("#searchbtn").change(function () {
            search();
         })

         $('#save').click(function () {
            if ($('#title').val() == '') {
               $('#error').html('Please provide a title');
               return;
            } else if ($('#year').val() == '' || !/^\d{4}$/.test($('#year').val())) {
               $('#error').html('Please provide a valid release year');
               return;
            } else if ($('#rating').val() == 'select') {
               $('#error').html('Please select a rating');
               return;
            } else {
               $('#error').html('');
               $.post('/addMovie', $('#newMovieForm').serialize(), function (data){
               if (data.success) {
                  $('#savedResult').html(data.msg)
               } else {
                  $('#error').html(data.msg);
               }
            });
            }
         });
      });

      function display(movie) {
         let out = "<div class='rounded shadow mt-2 p-2 result'><p>" 
            + movie.title + "</p><p class='ml-2'> " + movie.description + "</p></div>";
         return out;
      }

      function search() {
         let searchstr = $('#search').val();
            let name ='<%= user %>';
            let info = {username: name, search: searchstr};
            $.post('/search', info, function (data){
               let res = JSON.parse(data);
               let out = '';
               res.forEach(element => {
                  out += display(element);
               });
               $('#results').html(out);
            });
      }
   </script>
</body>
</html>